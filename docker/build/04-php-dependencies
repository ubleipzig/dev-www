#!/bin/sh

###################
#  php-dependencies
###################

set -e
PHPIZE_DEPS="autoconf \
  cmake \
  file \
  g++ \
  gcc \
  libc-dev \
  pcre-dev \
  make \
  git \
  pkgconf \
  re2c \
  curl-dev \
  freetype-dev \
  libpng-dev  \
  libjpeg-turbo-dev \
  imagemagick-dev \
  bzip2-dev \
  libzip-dev \
  zlib-dev \
";


export NPROC=$(grep -c ^processor /proc/cpuinfo 2>/dev/null || 1)

echo 'Installing php dependencies'
apk add --no-cache --virtual .persistent-deps \
    freetype \
    libpng \
    libjpeg-turbo \
    icu-dev \
    icu-libs \
    imagemagick \
    imagemagick-libs \
    libressl-dev \
    libxml2-dev \
    libzip \
    oniguruma-dev

apk add --update --no-cache --virtual .build-deps $PHPIZE_DEPS;

docker-php-ext-configure curl;
docker-php-ext-configure gd --with-freetype --with-jpeg;
docker-php-ext-configure hash --with-mhash;
docker-php-ext-configure intl --enable-intl;
docker-php-ext-configure mbstring --enable-mbstring;
docker-php-ext-configure opcache --enable-opcache;
docker-php-ext-configure xml;
docker-php-ext-configure zip --with-zip;

pecl install imagick xdebug
docker-php-ext-enable --ini-name docker-php-ext-imagick.ini imagick
docker-php-ext-enable xdebug

docker-php-ext-install -j ${NPROC} \
    curl \
    exif \
    gd \
    fileinfo \
    intl \
    mbstring \
    mysqli \
    opcache \
    pdo_mysql \
    session \
    xml \
    zip \
;

# get real extension of modules
runDeps="$( \
    scanelf --needed --nobanner --format '%n#p' --recursive /usr/local/lib/php/extensions \
        | tr ',' '\n' \
        | sort -u \
        | awk 'system("[ -e /usr/local/lib/" $1 " ]") == 0 { next } { print "so:" $1 }' \
)"; \
apk add --virtual .phpext-rundeps $runDeps;

echo "Cleaning install libaries and cache"
pecl clear-cache;
apk del --no-network .build-deps;